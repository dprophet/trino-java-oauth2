networks:
  oauth-test-network:
    driver: bridge

services:
  hydra:
    image: oryd/hydra:v25.4.0
    container_name: hydra
    networks:
      - oauth-test-network
    ports:
      - "4444:4444" # Public port
      - "4445:4445" # Admin port
      - "5555:5555" # Port for hydra token user
    command: serve all -c /etc/config/hydra.yml --dev
    environment:
      - SERVE_PUBLIC_CORS_ENABLED=true
      - SERVE_PUBLIC_CORS_ALLOWED_ORIGINS=*
      - URLS_SELF_ISSUER=${HYDRA_PUBLIC_URL:-http://hydra:4444}
      - URLS_CONSENT=${CONSENT_URL:-http://consent:3000}/consent
      - URLS_LOGIN=${CONSENT_URL:-http://consent:3000}/login
      - URLS_LOGOUT=${CONSENT_URL:-http://consent:3000}/logout
      - URLS_DEVICE_VERIFICATION=${CONSENT_URL:-http://consent:3000}/device/verify
      - URLS_DEVICE_SUCCESS=${CONSENT_URL:-http://consent:3000}/device/success
      - LOG_LEAK_SENSITIVE_VALUES=true   # Prints JWT secrets in logs for easier test debugging
    volumes:
      - type: bind
        source: ./hydra.yml
        target: /etc/config/hydra.yml
    restart: on-failure

  consent:
    image: oryd/hydra-login-consent-node:v25.4.0
    container_name: consent
    networks:
      - oauth-test-network
    ports:
      - "3000:3000"
    environment:
      - HYDRA_ADMIN_URL=${HYDRA_ADMIN_URL:-http://hydra:4445}
    restart: on-failure

  test:
    build:
      context: ..
      dockerfile: tests/Dockerfile
      args:
        - HTTP_PROXY=${HTTP_PROXY}
        - HTTPS_PROXY=${HTTPS_PROXY}
        - NO_PROXY=${NO_PROXY}
    image: trino-oauth2-tests:latest
    container_name: trino-oauth2-tests
    networks:
      - oauth-test-network
    depends_on:
      - hydra
      - consent
    environment:
      - HYDRA_ADMIN_URL=http://hydra:4445
      - HYDRA_PUBLIC_URL=http://hydra:4444
      - CONSENT_URL=http://consent:3000
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1,hydra,consent}
    command: bash -c "sleep 5 && chmod +x /app/configure-hydra.sh && /app/configure-hydra.sh && if [ -f /app/settings.xml ]; then mvn -s /app/settings.xml -Dmaven.resolver.transport=wagon -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -Dmaven.wagon.http.ssl.ignore.validity.dates=true test -Dgroups=e2e; else mvn test -Dgroups=e2e; fi"
